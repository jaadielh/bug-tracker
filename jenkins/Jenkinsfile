pipeline {
  agent any

  stages {

    stage('Unit Tests Backend') {
        agent {
            docker {
                image 'golang:1.22-alpine'
                reuseNode true
            }
        }

        steps {
            dir('bugtracker-backend') {
                sh '''
                    export GOCACHE=$WORKSPACE/.gocache
                    export GOMODCACHE=$WORKSPACE/.gomodcache
                    export GOPATH=$WORKSPACE/.gopath

                    mkdir -p $GOCACHE $GOMODCACHE $GOPATH

                    go install github.com/jstemmer/go-junit-report/v2@latest

                    go test -v ./... | go-junit-report -set-exit-code > test-results.xml

                    go test -coverprofile=coverage.out ./...
                    go tool cover -html=coverage.out -o coverage.html

                    mkdir -p reports
                    mv coverage.html reports/
                '''
            }
        }

            post {
                always {
                junit 'bugtracker-backend/test-results.xml'

                publishHTML(target: [
                    reportDir: 'bugtracker-backend/reports',
                    reportFiles: 'coverage.html',
                    reportName: 'Backend Coverage',
                        keepAll: true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: false
                ])
            }
        }
    }


    stage('Unit Tests Frontend') {
      agent {
        docker { image 'node:20-alpine'; reuseNode true }
      }
      steps {
        dir('bugtracker-frontend') {
          sh '''
            npm ci
            npm test
            mkdir -p reports
            mv coverage reports/
          '''
        }
      }
      post {
        always {
          junit 'bugtracker-frontend/reports/junit.xml'
          publishHTML(target: [
            reportDir: 'bugtracker-frontend/reports/coverage',
            reportFiles: 'index.html',
            reportName: 'Frontend Coverage',
            keepAll: true,
            alwaysLinkToLastBuild: true,
            allowMissing: false
          ])
        }
      }
    }

    stage('Launch Application') {
      agent {
        docker {
          image 'docker:27.5.1'
          reuseNode true
          args '-v /var/run/docker.sock:/var/run/docker.sock -u 0'
        }
      }
      steps {
        sh 'docker compose up --build -d'
        sh 'sleep 20'
      }
    }

    stage('Playwright API Tests') {
      agent {
        docker {
          image 'mcr.microsoft.com/playwright:v1.57.0-jammy'
          reuseNode true
          args '-u 0 --network=host'
        }
      }
      steps {
        dir('tests-api') {
          sh 'npm install'
          sh 'npx playwright test'
        }
      }
      post {
        always {
          junit 'tests-api/test-results/results.xml'
          publishHTML(target: [
            reportDir: 'tests-api/playwright-report',
            reportFiles: 'index.html',
            reportName: 'API Test Report',
            keepAll: true,
            alwaysLinkToLastBuild: true,
            allowMissing: false
          ])
        }
      }
    }

    stage('E2E Tests') {
      agent {
        docker {
          image 'mcr.microsoft.com/playwright:v1.57.0-jammy'
          reuseNode true
          args '-u 0 --network=host'
        }
      }
      steps {
        dir('tests-e2e') {
          sh 'npm install'
          sh 'npx playwright test'
        }
      }
      post {
        always {
          junit 'tests-e2e/**/results.xml'
          publishHTML(target: [
            reportDir: 'tests-e2e/playwright-report',
            reportFiles: 'index.html',
            reportName: 'E2E Test Report',
            keepAll: true,
            alwaysLinkToLastBuild: true,
            allowMissing: false
          ])
        }
      }
    }

    stage('Performance Tests (K6 + Grafana)') {
      agent {
        docker {
          image 'grafana/k6:latest'
          args '--network=host'
        }
      }
      steps {
        dir('test-perf') {
          sh '''
            mkdir -p reports
            k6 run script.js \
              --out influxdb=http://localhost:8086/k6 \
              --summary-export=reports/summary.json
          '''

          sh '''
            apk add --no-cache nodejs npm
            npm install -g k6-to-junit k6-reporter
            k6-to-junit reports/summary.json > reports/k6-junit.xml
            k6-reporter reports/summary.json --output reports/perf-report.html
          '''
        }
      }
      post {
        always {
          junit 'test-perf/reports/k6-junit.xml'
          publishHTML(target: [
            reportDir: 'test-perf/reports',
            reportFiles: 'perf-report.html',
            reportName: 'K6 Performance Report',
            keepAll: true,
            alwaysLinkToLastBuild: true,
            allowMissing: false
          ])
        }
      }
    }
  }
}
